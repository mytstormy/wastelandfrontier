{"ts":1374768898986,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"<?php\n/*\n@Author = Kent Savage\n*/\n\n// Start the session\nsession_save_path(\"/home/users/web/b746/sl.i1savage/public_html/cgi-bin/tmp\");\nsession_start();\nsetcookie(\"PHPSESSION\",$_COOKIE['PHPSESSION'],time()+1800);\n\n// is the one accessing this page logged in or not?\nif (!isset($_SESSION['logged_in']) || $_SESSION['logged_in'] !== true) {\n\t// not logged in, move to login page\n\theader('Location: expired.php');\n\texit;\n}\n\n\t\t$user_id = $_SESSION['user_id'];\n\t\t\n\t\tinclude 'mods/config.php';\n\t\tinclude 'Connections/Rebirth1.php';\n\n\t\tinclude 'mods/opendb.php';\n\n\t\tinclude 'mods/userinfo.php';\n\t\tinclude 'mods/pagesecurity.php';\n\n\t\tinclude 'mods/vehicleinfo.php';\n\n\n// we're obviously assuming some things here - what?  and we will need to double check it...\n\t\t// for each action - check the assumptions\n\n\n// sections for each action...\n\n\n\n\t//*********************************************//\n\n\t// battle\n\t\t// $_GET from <a href=\"actions.php?action=fight&from='.$file_name.'&id='.$cellmobs['mob_id'].'\">Fight </a>\n\t\t\t// also can scan the creature?  for energy...\n\t\t\t// $_GET from <a href=\"actions.php?action=scanmob&from='.$file_name.'&id='.$cellmobs['mob_id'].'\">Scan </a>\n\t\n\t\n\t\n\t//*********************************************//\n\t\n\t\t// surveying?  is related, how does surveying allow a person to mine more than what is in the nodes tbl?\n\t\t\t// answer: it doesnt - it only allows them to see what is deeper via the depth field\n\t\t\t// but how do i only allow that person to see the node... could it create a temp node there that is locked to the person?  and perhaps limit how often they can survey?\n\t\t\t// no no no - its all done - surveying is automatic for now...  based on survey skill...\n\t\t\t// so - not getting anything - will comment out the survey link from the details page...\n\t\t\t// $_GET from <a href=\"actions.php?action=survey&from='.$file_name.'&loc_x='.$det_loc_x.'&loc_y='.$det_loc_y.'\">Survey </a>\n\t\t\t\t// here is where we would consider any surveying skill\n\t\n\t\n\t\n\t//*********************************************//\n\t// mining\n\t\t\t// $_GET from <a href=\"actions.php?action=mine&from='.$file_name.'&id='.$cellnodes['node_id'].'\">Mine </a>\n\t\t\tif($_GET[\"action\"] == 'mine' && isset($_GET[\"node_id\"]) && isset($_GET[\"from\"])){\n\t\t\t\t$referer = $_GET[\"from\"];\n\t\t\t// need to make sure the vehicle is at the location of this node, then check survey level?\n\t\t\t\t\t$node_id = $_GET[node_id];\n\t\t\t\t$query = \"SELECT * FROM tbl_nodes, tbl_item_types WHERE node_type = item_type_id and node_id = '$node_id'\";\n    \t\t\t$noderesult =  mysql_query($query) or die('Query failed. ' . mysql_error());\n\t\t\t\t$node_detail = mysql_fetch_array($noderesult);\n\t\t\t\tif($node_detail['node_loc_x'] == $vehicle_loc_x && $node_detail['node_loc_y'] == $vehicle_loc_y){\n\n\t\t\t// check mining module equipped on the vehicle = amount to mine && remaining space in cargo\n\t\t\t\t$module_mining_amount = 15;\n\t\t\t\tif($module_mining_amount >= $node_detail[\"node_qty\"]){\n\t\t\t\t\t$module_mining_amount = $node_detail[\"node_qty\"];\n\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t// $vehicle_current_cargo = 500;\n\t\t\t\t// $vehicle_max_cargo = 2000;\n\t\t\t\t// eventually - get these variables from the vehicle mods and vehicleinfo etc\n\t\t\t// compare & mine the smaller value as long as there is still space in cargo and still material left in the node...\n\t\t\tif($module_mining_amount >= ($vehicle_max_cargo - $vehicle_current_cargo)){\n\t\t\t\t$module_mining_amount = ($vehicle_max_cargo - $vehicle_current_cargo);\n\t\t\t}\n\t\t\tif($module_mining_amount <= ($vehicle_max_cargo - $vehicle_current_cargo)){\n\t\t\t\t// later - may add random bonuses to yield? based on random or skill in mining?\n\t\t\t\t\n\t\t\t// subtract mining amount from node qty or delete the node if it is depleted.\n\t\t\t\t\t// - unless the amount is unlimited - it will not be adjusted below...\n\t\t\t\t\t// unlimited nodes have qty of 99999\n\t\t\t\t$node_id = $node_detail['node_id'];\n\t\t\t\tif($node_detail['node_qty'] == 99999){\n\t\t\t\t\t// do not subtract from it... else - \n\t\t\t\t}elseif($module_mining_amount == $node_detail[\"node_qty\"]){\n\t\t\t\t$deletenodequery = \"DELETE FROM tbl_nodes WHERE node_id = '$node_id' LIMIT 1\";\n    \t\t\t$deletenode =  mysql_query($deletenodequery) or die('Query failed. ' . mysql_error());\n\t\t\t\t}else{\n\t\t\t\t$newqty = $node_detail['node_qty'] - $module_mining_amount;\n\t\t\t\t$query = \"UPDATE tbl_nodes SET node_qty = '$newqty' WHERE node_id = '$node_id' LIMIT 1\";\n    \t\t\t\t$adjustnode =  mysql_query($query) or die('Query failed. ' . mysql_error());\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t// add mining amount to cargo\n\t\t\t\t$newcargo = ($vehicle_current_cargo + $module_mining_amount);\n\t\t\t\t// $query = \"UPDATE tbl_vehicles SET vehicle_current_cargo = '$newcargo' WHERE vehicle_id = '$vehicle_id' LIMIT 1\";\n    \t\t\t\t// $adjustvehicle =  mysql_query($query) or die('Query failed. ' . mysql_error());\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t// costs energy to mine - ergo - subtract energy from user total energy\n\t\t\t// add mining experience point/s to user experience\n\t\t\t\t$newenergy = $user_energy - 1;\n\t\t\t\t$newminingexp = $user_mining_exp + 1;\n\t\t\t\t$query = \"UPDATE tbl_users SET user_energy = '$newenergy', user_mining_exp = '$newminingexp' WHERE user_id = '$user_id' LIMIT 1\";\n    \t\t\t\t$adjustuser =  mysql_query($query) or die('Query failed. ' . mysql_error());\n\t\t\t\n\t\t\t\n\t\t\t// create the item to add to inventory.\n\t\t\t\t$item_type_id = $node_detail['node_type'];\n\t\t\t\t$query = \"SELECT * FROM tbl_item_types WHERE item_type_id = '$item_type_id'\";\n    \t\t\t$nodeinforesult =  mysql_query($query) or die('Query failed. ' . mysql_error());\n\t\t\t\t$nodeinfo = mysql_fetch_array($nodeinforesult);\n\t\t\t\t// raw materials = 3\n\t\t\t\n\t\t\t// stack the item if there are already some in the cargo\n\t\t\t\t$query = \"SELECT * FROM tbl_items WHERE item_user_id = '$user_id' and item_type_id = '$item_type_id' and item_status = '1' and item_location = '$vehicle_location'\";\n    \t\t\t$stackresult =  mysql_query($query) or die('Query failed. ' . mysql_error());\n\t\t\t\t//$stackcheck = mysql_num_rows($stackresult);\n\t\t\tif(mysql_num_rows($stackresult) == 1){\n\t\t\t// stack them if there are some already\t\n\t\t\t\t$stackresult = mysql_fetch_array($stackresult);\n\t\t\t$stackid = $stackresult['item_id'];\n\t\t\t$newstackqty = $module_mining_amount + $stackresult['item_qty'];\n\t\t\t\t$query = \"UPDATE tbl_items SET item_qty = '$newstackqty' WHERE item_id = '$stackid' LIMIT 1\";\n    \t\t\t\t$stackitems =  mysql_query($query) or die('Query failed. ' . mysql_error());\n\t\t\t}else{\n\t\t\t// or, just add it to the inventory\n\t\t\t// for now - vehicle_location = 0 since they already have their own x,y coords - but use the var from vehicles include - $vehicle_location\n\t$sqlinsert = \"INSERT INTO tbl_items \n\t        (item_user_id, item_type_id, item_status, item_location, item_qty)\n\t\t\tVALUES('$user_id', '$item_type_id', '1', '$vehicle_location', '$module_mining_amount')\";\n\t\n\t$resultinsert = mysql_query($sqlinsert) or die('Query failed. ' . mysql_error()); \n\t\t\t\t\n\t\t\t} // end stacking if / else\n\t\t\t\n\t\t\t} // end mining amounts/ node remaining / cargo remaining if statement\n\t\t\t\n\t\t\t// include any scripts that must run to update veh data\n\t\t\tinclude 'mods/vehicleinfo.php';\n\t\t\t\n\t\t\t// set a session var to give success message - with mining amounts etc.\n\t\t\t\t$_SESSION['mining_confirm'] = 'Successfully Mined '.$module_mining_amount.' units of '.$node_detail[\"item_type_name\"].'.';\n\n\theader('Location: celldetail.php?loc_x='.$vehicle_loc_x.'&loc_y='.$vehicle_loc_y);\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\t\n\t//************** VENDOR BUY/SELL (all except vehicles) *********************//\n\t\t\t// buy / sell script to and from vendors...\n\t\t\t// get vars from $_POST[\"action\"] == buyfromvendor or == selltovendor\n \t\t\t// *************\n          \t// <input type='hidden' name='action' value='vendor'>\n\t\t\t// <input type=\"text\" size=\"4\" name=\"transaction_qty\" value=\"1\">\n\t\t\t// <input type='hidden' name='transaction_direction' value='purchase'>\n\t\t\t// <input type='hidden' name='form_vehicle_max_cargo' value='\".$vehicle_max_cargo.\"'>\n\t\t\t// <input type='hidden' name='max_purchase_vol' value='\".$max_purchase_vol.\"'>\n\t\t\t// <input type='hidden' name='form_user_credits' value='\".$user_credits.\"'>\n\t\t\t// <input type='hidden' name='form_vehicle_current_cargo' value='\".$vehicle_current_cargo.\"'>\n\t\t\t// <input type='hidden' name='form_vehicle_loc_x' value='\".$vehicle_loc_x.\"'>\n\t\t\t// <input type='hidden' name='form_vehicle_loc_y' value='\".$vehicle_loc_y.\"'>\n\t\t\t// <input type='hidden' name='vendor_id' value='\".$vendors['vendor_id'].\"'>\n\t\t\t// <input type='hidden' name='vendor_item_current_price' value='\".$vendoritems['vendor_item_current_price'].\"'>\n\t\t\t// <input type='hidden' name='vendor_item_qty' value='\".$vendoritems['vendor_item_qty'].\"'>\n\t\t\t// <input type='hidden' name='vendor_item_id' value='\".$vendoritems['vendor_item_id'].\"'>\n            \n            // this value can change depending on the source page...\n            // <input type=\"hidden\" name=\"referer\" value=\"vendordet.php\">\n\t\t\t\n\t\t\t\n\t\t\tif(($_POST['action']) == 'vendor' && isset($_POST['transaction_direction']) && isset($_POST['transaction_qty'])){\n\t\t\t\t$_SESSION['vendor_error'] = '';\n\t\t\t\t\n\t\t\t\t$posted_transaction_qty = $_POST['transaction_qty'];\n\t\t\t\t//echo 'Value 1 is '.$posted_transaction_qty.'<br />';\n\t\t\t\t$posted_transaction_direction = $_POST['transaction_direction'];\n\t\t\t\t//echo 'Value 2 is '.$posted_transaction_direction.'<br />';\n\t\t\t\t$posted_form_vehicle_max_cargo = $_POST['form_vehicle_max_cargo'];\n\t\t\t\t//echo 'Value 3 is '.$posted_form_vehicle_max_cargo.'<br />';\n\t\t\t\t$posted_max_purchase_vol = $_POST['max_purchase_vol'];\n\t\t\t\t//echo 'Value 4 is '.$posted_max_purchase_vol.'<br />';\n\t\t\t\t$posted_form_user_credits = $_POST['form_user_credits'];\n\t\t\t\t//echo 'Value 5 is '.$posted_form_user_credits.'<br />';\n\t\t\t\t$posted_form_vehicle_current_cargo = $_POST['form_vehicle_current_cargo'];\n\t\t\t\t//echo 'Value 6 is '.$posted_form_vehicle_current_cargo.'<br />';\n\t\t\t\t$posted_form_dest_location = $_POST['form_dest_loc'];\n\t\t\t\t$posted_form_vehicle_loc_x = $_POST['form_vehicle_loc_x'];\n\t\t\t\t//echo 'Value 7 is '.$posted_form_vehicle_loc_x.'<br />';\n\t\t\t\t$posted_form_vehicle_loc_y = $_POST['form_vehicle_loc_y'];\n\t\t\t\t//echo 'Value 8 is '.$posted_form_vehicle_loc_y.'<br />';\n\t\t\t\t$posted_vendor_id = $_POST['vendor_id'];\n\t\t\t\t//echo 'Value 9 is '.$posted_vendor_id.'<br />';\n\t\t\t\t$posted_vendor_item_current_price = $_POST['vendor_item_current_price'];\n\t\t\t\t//echo 'Value 10 is '.$posted_vendor_item_current_price.'<br />';\n\t\t\t\t$posted_vendor_item_id = $_POST['vendor_item_id'];\n\t\t\t\t//echo 'Value 11 is '.$posted_vendor_item_id.'<br />';\n\t\t\t\t$posted_vendor_item_qty = $_POST['vendor_item_qty'];\n\t\t\t\t//echo 'Value 12 is '.$posted_vendor_item_qty.'<br />';\n\t\t\t\t$referer_page = $_POST['referer'];\n\t\t\t\t//echo 'Value 13 is '.$referer_page.'<br />';\n\t\t\t\t\n\t\t\t\t// check all user vars from form to make sure they match current values...\n\n\n\t\t\t\t\t// does the user still have same amt of credits?\n\t\t\t\t\tif($user_credits !== $posted_form_user_credits){\n\t\t\t\t\t\t$_SESSION['vendor_error'] = $_SESSION['vendor_error'].'There is a discrepancy in your current funds.<br />';\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\t// check vehicle_max_cargo and vehicle_current_cargo\n\t\t\t\t\tif($vehicle_max_cargo != $posted_form_vehicle_max_cargo || $vehicle_current_cargo != $posted_form_vehicle_current_cargo){\n\t\t\t\t\t\t$_SESSION['vendor_error'] = $_SESSION['vendor_error'].'For some reason - your vehicle cargo space has changed.<br />\n\t\t\t\t\t\tvehicle_max_cargo = '.$vehicle_max_cargo.'<br />\n\t\t\t\t\t\tposted_form_vehicle_max_cargo = '.$posted_form_vehicle_max_cargo.'<br />\n\t\t\t\t\t\tvehicle_current_cargo = '.$vehicle_current_cargo.'<br />\n\t\t\t\t\t\tposted_form_vehicle_current_cargo = '.$posted_form_vehicle_current_cargo.'<br />';\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\t// check veh location? yes, better do that\n\t\t\t\t\tif($vehicle_loc_x !== $posted_form_vehicle_loc_x || $vehicle_loc_y !== $posted_form_vehicle_loc_y){\n\t\t\t\t\t\t$_SESSION['vendor_error'] = $_SESSION['vendor_error'].'Somehow, your vehicle is not at the correct location or has moved since loading this page.<br />';\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\t// if vendor session error is set - send 'em back right now... *poof*\n\t\t\t\t\t\tif($_SESSION['vendor_error'] !== ''){\n\t\t\t\t\t\t$_SESSION['vendor_error'] = $_SESSION['vendor_error'].'Please refresh and attempt your transaction again.<br />';\n\t\t\t\t\t\theader('Location: '.$referer_page);\n\t\t\t\t\t\t}\n\t\t\t\t\n\t\t\t\t// I appear to be assuming that i'm setting up the purchase script first... \n\t\t\tif(($_POST['transaction_direction']) == 'purchase'){\n\t\t\t\t\t// need the vehicle location set correct - also need to correct the inventory managment scripts for locations\n\t\t\t\t\t// purchases must go into the current vehicle - how else you gonna transport it? lol\n\t\t\t\t\t\t// might add delivery options later...\n\t\t\t\t\t\n\t\t\t\t\t// is the item still available?\n\t\t\t\t\t\t// get item info from item id\n\t\t\t\t\t\t\t$query = \"SELECT * FROM tbl_items WHERE item_id = '$posted_vendor_item_id'\";\n    \t\t\t\t\t\t$itemresults =  mysql_query($query) or die('Query failed. ' . mysql_error());\n\t\t\t\t\t\t\t  $iteminfo = mysql_fetch_array($itemresults,MYSQL_ASSOC);\n\t\t\t\t\t\t\t\t$item_id = $iteminfo['item_id'];\n\t\t\t\t\t\t\t\t$item_type_id = $iteminfo['item_type_id'];\n\t\t\t\t\t\t\t\t$item_qty = $iteminfo['item_qty'];\n\t\t\t\t\t\t\t// is the purchase qty available?\n\t\t\t\t\t\t\tif($posted_transaction_qty > $item_qty){\n\t\t\t\t\t\t\t\t$_SESSION['vendor_error'] = $_SESSION['vendor_error'].'The quantity you attempted to purchase is no longer available. Please refresh and attempt your transaction again.<br />';\n\t\t\t\t\t\t\t\theader('Location: '.$referer_page);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t// now that those values have been checked... proceed with transaction\n\n\t\t\t\t\t\t\t\t// check for item to stack in veh inventory\n\n\t\t\t\t// check dest inventory for a duplicate item\n\t\t\t\t\t\t$query = \"SELECT * FROM tbl_items WHERE item_user_id = '$user_id' and item_type_id = '$item_type_id' and item_status = '1' and item_location = '$posted_form_dest_location'\";\n    \t\t\t\t\t$dupecheck =  mysql_query($query) or die('Query failed. ' . mysql_error());\n\t\t\t\t\t\tif(mysql_num_rows($dupecheck) == 0){\n\t\t\t\t\t// no dupe - \n\t\t\t\t\t\t// only partial purchases - even reducing vendor inv to 0 is fine\n\t\t\t\t\t\t\tif(($posted_transaction_qty <= $item_qty) && ($posted_transaction_qty <= $posted_form_vehicle_max_cargo)){\n\t\t\t\t\t\t\t// moving partial - create new item and set amt in base/hangar\n\t\t\t\t\t\t\t\t$new_qty = $posted_transaction_qty;\n\t\t\t\t\t\t\t\t$sqlinsert = \"INSERT INTO tbl_items \n\t\t\t\t\t\t        (item_user_id, item_type_id, item_status, item_location, item_qty)\n\t\t\t\t\t\t\t\tVALUES('$user_id', '$item_type_id', '1', '$posted_form_dest_location', '$new_qty')\";\n\t\t\t\t\t\t\t\t$resultinsert = mysql_query($sqlinsert) or die('Query failed. ' . mysql_error()); \n\t\t\t\t\t\t\t// subract and leave remainder in vendor inventory... unless qty is unlimited?  99999? could be higher?\n\t\t\t\t\t\t\t\t\tif($item_qty == 99999){\n\t\t\t\t\t\t\t\t// if we leave it at 99999 - why change anything :)\n\t\t\t\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\t\t$adj_qty = $item_qty - $posted_transaction_qty;\n\t\t\t\t\t\t\t\t$query = \"UPDATE tbl_items SET item_qty = '$adj_qty' WHERE item_id = '$item_id' LIMIT 1\";\n    \t\t\t\t\t\t\t$adjustqty =  mysql_query($query) or die('Query failed. ' . mysql_error());\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\t\n\t\t\t\t\t\t\t\t// leave this part in for sales (assuming purchase only for the time being)\n//\t\t\t\t\t\t\t\telseif($_POST[\"move_qty\"] == $iteminfo[item_qty]){\n//\t\t\t\t\t\t\t// if moving all - change item location and done.\n//\t\t\t\t\t\t\t\t$query = \"UPDATE tbl_items SET item_location = '$dest_loc' WHERE item_id = '$item_id' LIMIT 1\";\n//    \t\t\t\t\t\t\t$changelocation =  mysql_query($query) or die('Query failed. ' . mysql_error());\n//\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t}// end no dupe move section\n\t\t\t\t\t\n\t\t\t\t\t// if duplicate exists, \n\t\t\t\t\t\tif(mysql_num_rows($dupecheck) > 0){\n\t\t\t\t\t\t\t$dupeinfo = mysql_fetch_array($dupecheck,MYSQL_ASSOC);\n\t\t\t\t\t\t\t$existing_id = $dupeinfo[item_id];\n\t\t\t\t\t\t\t$existing_qty = $dupeinfo[item_qty];\n\t\t\t\t\t\t// is partial move? or all of item? - same procedure for stacking full or partial move\n\t\t\t\t\t\t\t\t// add move amt then go to cleanup section for remainder if any... wont be needed for purchases even to 0 left\n\t\t\t\t\t\t\t\t$adj_qty = $existing_qty + $posted_transaction_qty;\n\t\t\t\t\t\t\t\t$query = \"UPDATE tbl_items SET item_qty = '$adj_qty' WHERE item_id = '$existing_id' LIMIT 1\";\n    \t\t\t\t\t\t\t$adjustqty =  mysql_query($query) or die('Query failed. ' . mysql_error());\n\n\t\t\t\t\t\t\t\t\tif($item_qty == 99999){\n\t\t\t\t\t\t\t\t// if we leave it at 99999 - why change anything :)\n\t\t\t\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\t\t$adj_qty = $item_qty - $posted_transaction_qty;\n\t\t\t\t\t\t\t\t$query = \"UPDATE tbl_items SET item_qty = '$adj_qty' WHERE item_id = '$item_id' LIMIT 1\";\n    \t\t\t\t\t\t\t$adjustqty =  mysql_query($query) or die('Query failed. ' . mysql_error());\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}// end dupe move section\n\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t// subtract monies for purchase\n\t\t\t\t\t\t\t\t\t$total_cost = $posted_vendor_item_current_price * $posted_transaction_qty;\n\t\t\t\t\t\t\t\t\t$new_user_credits = $user_credits - $total_cost;\n\t\t\t\t\t\t\t\t\t$moniesquery = \"UPDATE tbl_users SET user_credits = '$new_user_credits' WHERE user_id = '$user_id' LIMIT 1\";\n\t\t\t\t\t\t\t\t\t$adjustmonies =  mysql_query($moniesquery) or die('Query failed. ' . mysql_error());\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t// add monies to global ticker ? any other tracking? create a purchase/sale db for tracking?\n\t\t\t\t\t\t\t\t$sqlinserttrans = \"INSERT INTO tbl_transactions \n\t\t\t\t\t\t        (trans_user_id, trans_direction, trans_item_id, trans_qty, trans_price)\n\t\t\t\t\t\t\t\tVALUES('$user_id', '1', '$item_type_id', '$posted_transaction_qty', '$posted_vendor_item_current_price')\";\n\t\t\t\t\t\t\t\t$resultinsert = mysql_query($sqlinserttrans) or die('Query failed. ' . mysql_error()); \n\t\t\t\t\t\t\t\t\n\t\t\t}// end purchase.\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\t// now for sale script... similar only in reverse\n\t\t\tif(($_POST['transaction_direction']) == 'sale'){\n\t\t\t\t\t// need the vehicle location set correct - also need to correct the inventory managment scripts for locations\n\t\t\t\t\t\n\t\t\t\t\t// is the item still available?\n\t\t\t\t\t\t// get item info from item id\n\t\t\t\t\t\t\t$query = \"SELECT * FROM tbl_items WHERE item_id = '$posted_vendor_item_id'\";\n    \t\t\t\t\t\t$itemresults =  mysql_query($query) or die('Query failed. ' . mysql_error());\n\t\t\t\t\t\t\t  $iteminfo = mysql_fetch_array($itemresults,MYSQL_ASSOC);\n\t\t\t\t\t\t\t\t$item_id = $iteminfo['item_id'];\n\t\t\t\t\t\t\t\t$item_type_id = $iteminfo['item_type_id'];\n\t\t\t\t\t\t\t\t$item_qty = $iteminfo['item_qty'];\n\t\t\t\t\t\t\t// is the purchase qty available?\n\t\t\t\t\t\t\tif($posted_transaction_qty > $item_qty){\n\t\t\t\t\t\t\t\t$_SESSION['vendor_error'] = $_SESSION['vendor_error'].'The quantity you are trying to sell is no longer available. Please refresh and attempt your transaction again.<br />';\n\t\t\t\t\t\t\t\theader('Location: '.$referer_page);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t// now that those values have been checked... proceed with transaction\n\n\t\t\t\t// check dest inventory for a duplicate item\n\t\t\t\t\t// for vendors - user_id will be 0 for now, and look for a matching location for the vendor which should match the value sent from teh form... not gonna check it for the time being\n\t\t\t\t\t\t$query = \"SELECT * FROM tbl_items WHERE item_user_id = '0' and item_type_id = '$item_type_id' and item_status = '1' and item_location = '$posted_form_dest_location'\";\n    \t\t\t\t\t$dupecheck =  mysql_query($query) or die('Query failed. ' . mysql_error());\n\t\t\t\t\t\tif(mysql_num_rows($dupecheck) == 0){\n\t\t\t\t\t// no dupe - \n\t\t\t\t\t\t// only partial sales\n\t\t\t\t\t\t\tif($posted_transaction_qty < $item_qty){\n\t\t\t\t\t\t\t// moving partial - create new item and set amt in vendor inventory\n\t\t\t\t\t\t\t\t// remember vendor user_id = 0\n\t\t\t\t\t\t\t\t$new_qty = $posted_transaction_qty;\n\t\t\t\t\t\t\t\t$sqlinsert = \"INSERT INTO tbl_items \n\t\t\t\t\t\t        (item_user_id, item_type_id, item_status, item_location, item_qty)\n\t\t\t\t\t\t\t\tVALUES('0', '$item_type_id', '1', '$posted_form_dest_location', '$new_qty')\";\n\t\t\t\t\t\t\t\t$resultinsert = mysql_query($sqlinsert) or die('Query failed. ' . mysql_error()); \n\t\t\t\t\t\t\t// subract and leave remainder in vehicle inventory... \n\t\t\t\t\t\t\t\t$adj_qty = $item_qty - $posted_transaction_qty;\n\t\t\t\t\t\t\t\t$query = \"UPDATE tbl_items SET item_qty = '$adj_qty' WHERE item_id = '$item_id' LIMIT 1\";\n    \t\t\t\t\t\t\t$adjustqty =  mysql_query($query) or die('Query failed. ' . mysql_error());\n\t\t\t\t\t\t\t}elseif($posted_transaction_qty == $item_qty){\n\t\t\t\t\t\t\t// if moving all - change item location and done.\n\t\t\t\t\t\t\t\t$query = \"UPDATE tbl_items SET item_user_id = '0', item_location = '$dest_loc' WHERE item_id = '$item_id' LIMIT 1\";\n    \t\t\t\t\t\t\t$changelocation =  mysql_query($query) or die('Query failed. ' . mysql_error());\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t}// end no dupe move section\n\t\t\t\t\t\n\t\t\t\t\t// if duplicate exists, \n\t\t\t\t\t\tif(mysql_num_rows($dupecheck) > 0){\n\t\t\t\t\t\t\t$dupeinfo = mysql_fetch_array($dupecheck,MYSQL_ASSOC);\n\t\t\t\t\t\t\t$existing_id = $dupeinfo[item_id];\n\t\t\t\t\t\t\t$existing_qty = $dupeinfo[item_qty];\n\t\t\t\t\t\t// is partial move? or all of item? - same procedure for stacking full or partial move\n\n\t\t\t\t\t\t\t\t// for vendors - if existing qty is 99999 - dont change it :)\n\t\t\t\t\t\t\t\t\tif($item_qty == 99999){\n\t\t\t\t\t\t\t\t// if we leave it at 99999 - why change anything :)\n\t\t\t\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\t\t\t\t// update it if not 99999  - this is where max/min's could come in handy...\n\t\t\t\t\t\t\t\t\t\t// so someone doesnt trigger an infinite inventory accidentally or on purpose!  :)\n\t\t\t\t\t\t\t\t$adj_qty = $existing_qty + $posted_transaction_qty;\n\t\t\t\t\t\t\t\t$query = \"UPDATE tbl_items SET item_qty = '$adj_qty' WHERE item_id = '$existing_id' LIMIT 1\";\n    \t\t\t\t\t\t\t$adjustqty =  mysql_query($query) or die('Query failed. ' . mysql_error());\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t// for user inventory\n\t\t\t\t\t\t\tif($posted_transaction_qty < $item_qty){\n\t\t\t\t\t\t\t\t$adj_qty = $item_qty - $posted_transaction_qty;\n\t\t\t\t\t\t\t\t$query = \"UPDATE tbl_items SET item_qty = '$adj_qty' WHERE item_id = '$item_id' LIMIT 1\";\n    \t\t\t\t\t\t\t$adjustqty =  mysql_query($query) or die('Query failed. ' . mysql_error());\n\t\t\t\t\t\t\t}elseif($posted_transaction_qty == $item_qty){\n\t\t\t\t\t\t\t// if sale qty is all of item qty - delete old row from inventory\n\t\t\t\t\t\t\t\t$deleteemptyquery = \"DELETE FROM tbl_items WHERE item_id = '$item_id' LIMIT 1\";\n    \t\t\t\t\t\t\t$deleteempty =  mysql_query($deleteemptyquery) or die('Query failed. ' . mysql_error());\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t}// end dupe move section\n\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t// give user the monies for the sale\n\t\t\t\t\t\t\t\t\t$total_sale = $posted_vendor_item_current_price * $posted_transaction_qty;\n\t\t\t\t\t\t\t\t\t$new_user_credits = $user_credits + $total_sale;\n\t\t\t\t\t\t\t\t\t$moniesquery = \"UPDATE tbl_users SET user_credits = '$new_user_credits' WHERE user_id = '$user_id' LIMIT 1\";\n\t\t\t\t\t\t\t\t\t$adjustmonies =  mysql_query($moniesquery) or die('Query failed. ' . mysql_error());\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t// add monies to global ticker ? any other tracking? create a purchase/sale db for tracking?\n\t\t\t\t\t\t\t\t$sqlinserttrans = \"INSERT INTO tbl_transactions \n\t\t\t\t\t\t        (trans_user_id, trans_direction, trans_item_id, trans_qty, trans_price)\n\t\t\t\t\t\t\t\tVALUES('$user_id', '2', '$item_type_id', '$posted_transaction_qty', '$posted_vendor_item_current_price')\";\n\t\t\t\t\t\t\t\t$resultinsert = mysql_query($sqlinserttrans) or die('Query failed. ' . mysql_error()); \n\t\t\t\t\t\t\t\t\n\t\t\t}// end sale.\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\n\t\t\t\t\n\t\t\t\t\n\t\t\t\t\n\t\t\t\t\n\t\t\t// set confirm message if there are no errors \n\t\t\t\t\t\tif($_SESSION['vendor_error'] == ''){\n\t\t\t\t\t\t$_SESSION['vendor_error'] = $_SESSION['vendor_error'].'There appear to have been no errors - your transaction is complete.  (Details will follow as the script is completed.)<br />\n\t\t\t\t\t\tPurchase Complete for: <br />\n\t\t\t\t\t\t';\n\t\t\t\t\t\t\n\t\t\t\t\t\t$_SESSION['prev_posted_vendor_id'] = $_POST['vendor_id'];\n\t\t\t\t\t\theader('Location: '.$referer_page);\n\t\t\t\t\t\t}\n\t\t\t\t\n\t\t\t// redirect to the referer page once transaction is complete\n\t\t\t\t//echo 'Incomplete Vendor Action...';\n\t\t\t}\n\n\n\n\n\n\n\n\n\t//*********************************************//\n\t\t// Move inventory script\n\t\t\tif(($_POST[\"action\"]) == 'move_invent' && isset($_POST[\"item_id\"]) && isset($_POST[\"move_qty\"])){\n\t\t\t\t// start move inventory if-else\n\t\t\t\t\t// inventory page wont allow moves unless veh loc matches current home base/ hangar loc\n\t\t\t\t\t\n\t\t\t\t\t// need to make this an all in one invnetory managment script... \n\t\t\t\t\t\t// creating a locations table - wich will have vehicles, hangars, guild banks... etc, \n\t\t\t\t\t\t// parameters passed will indicate the from --> and to locations... script will take that\n\t\t\t\t\t\t// and move item accordingly...\n\t\t\t\t\t\t$from_loc = $_POST[\"from_loc\"];\n\t\t\t\t\t\t$dest_loc = $_POST[\"to_loc\"];\n\t\t\t\t\t\t$referer_page = $_POST[\"referer\"];\n\t\t\t\t\n\t\t\t\t// get item info from item id\n\t\t\t$query = \"SELECT * FROM tbl_items WHERE item_user_id = '$user_id' and item_id = '\".$_POST['item_id'].\"'\";\n    \t\t$itemresults =  mysql_query($query) or die('Query failed. ' . mysql_error());\n\t\t\t\t\t$iteminfo = mysql_fetch_array($itemresults,MYSQL_ASSOC);\n\t\t\t\t\t$item_id = $iteminfo['item_id'];\n\t\t\t\t\t$item_type_id = $iteminfo['item_type_id'];\n\t\t\t\t\t$item_qty = $iteminfo['item_qty'];\n\t\t\t\t\t\n\t\t\t\t// check dest inventory for a duplicate item\n\t\t\t\t\t\t$query = \"SELECT * FROM tbl_items WHERE item_user_id = '$user_id' and item_type_id = '$item_type_id' and item_status = '1' and item_location = '$dest_loc'\";\n    \t\t\t\t\t$dupecheck =  mysql_query($query) or die('Query failed. ' . mysql_error());\n\t\t\t\t\t\tif(mysql_num_rows($dupecheck) == 0){\n\t\t\t\t\t// no dupe - \n\t\t\t\t\t\t// is partial move? or all of item?\n\t\t\t\t\t\t\tif(($_POST[\"move_qty\"] < $iteminfo[item_qty]) && ($_POST[\"move_qty\"] > 0)){\n\t\t\t\t\t\t\t// moving partial - create new item and set amt in base/hangar\n\t\t\t\t\t\t\t\t$new_qty = $_POST[\"move_qty\"];\n\t\t\t\t\t\t\t\t$sqlinsert = \"INSERT INTO tbl_items \n\t\t\t\t\t\t        (item_user_id, item_type_id, item_status, item_location, item_qty)\n\t\t\t\t\t\t\t\tVALUES('$user_id', '$item_type_id', '1', '$dest_loc', '$new_qty')\";\n\t\t\t\t\t\t\t\t$resultinsert = mysql_query($sqlinsert) or die('Query failed. ' . mysql_error()); \n\t\t\t\t\t\t\t// subract and leave remainder in veh invent\n\t\t\t\t\t\t\t\t$adj_qty = $item_qty - $_POST[\"move_qty\"];\n\t\t\t\t\t\t\t\t$query = \"UPDATE tbl_items SET item_qty = '$adj_qty' WHERE item_id = '$item_id' LIMIT 1\";\n    \t\t\t\t\t\t\t$adjustqty =  mysql_query($query) or die('Query failed. ' . mysql_error());\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t}elseif($_POST[\"move_qty\"] == $iteminfo[item_qty]){\n\t\t\t\t\t\t\t// if moving all - change item location and done.\n\t\t\t\t\t\t\t\t$query = \"UPDATE tbl_items SET item_location = '$dest_loc' WHERE item_id = '$item_id' LIMIT 1\";\n    \t\t\t\t\t\t\t$changelocation =  mysql_query($query) or die('Query failed. ' . mysql_error());\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}// end no dupe move section\n\t\t\t\t\t\n\t\t\t\t\t// if duplicate exists, \n\t\t\t\t\t\tif(mysql_num_rows($dupecheck) > 0){\n\t\t\t\t\t\t\t$dupeinfo = mysql_fetch_array($dupecheck,MYSQL_ASSOC);\n\t\t\t\t\t\t\t$existing_id = $dupeinfo[item_id];\n\t\t\t\t\t\t\t$existing_qty = $dupeinfo[item_qty];\n\t\t\t\t\t\t// is partial move? or all of item? - same procedure for stacking full or partial move\n\t\t\t\t\t\t\t\t// add move amt then go to cleanup section for remainder if any...\n\t\t\t\t\t\t\t\t$adj_qty = $existing_qty + $_POST[\"move_qty\"];\n\t\t\t\t\t\t\t\t$query = \"UPDATE tbl_items SET item_qty = '$adj_qty' WHERE item_id = '$existing_id' LIMIT 1\";\n    \t\t\t\t\t\t\t$adjustqty =  mysql_query($query) or die('Query failed. ' . mysql_error());\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tif(($_POST[\"move_qty\"] < $iteminfo[item_qty]) && ($_POST[\"move_qty\"] > 0)){\n\t\t\t\t\t\t\t// if move qty is between 0 and full amt - update for new qty.\n\t\t\t\t\t\t\t\t$adj_qty = $item_qty - $_POST[\"move_qty\"];\n\t\t\t\t\t\t\t\t$query = \"UPDATE tbl_items SET item_qty = '$adj_qty' WHERE item_id = '$item_id' LIMIT 1\";\n    \t\t\t\t\t\t\t$adjustqty =  mysql_query($query) or die('Query failed. ' . mysql_error());\n\t\t\t\t\t\t\t}elseif($_POST[\"move_qty\"] == $iteminfo[item_qty]){\n\t\t\t\t\t\t\t// if move qty is all of item qty - delete old row from inventory\n\t\t\t\t\t\t\t\t$deleteemptyquery = \"DELETE FROM tbl_items WHERE item_id = '$item_id' LIMIT 1\";\n    \t\t\t\t\t\t\t$deleteempty =  mysql_query($deleteemptyquery) or die('Query failed. ' . mysql_error());\n\t\t\t\t\t\t\t// echo \"Something is wrong....\";\n\t\t\t\t\t\t\t} \n\t\t\t\t\t\t}// end dupe move section\n\t\t\t\t\t// include any scripts that must run to update veh data\n\t\t\t\t\tinclude 'mods/vehicleinfo.php';\n\t\t\t\theader('Location: '.$referer_page);\n\t\t\t}\n\t\n\t//*********************************************//\n\t\n\t// scanning\n\t\t\t// this is just examining said item for what?  um, size? weight? contents? perhaps...\n\t\t// $_GET from <a href=\"actions.php?action=scan&from='.$file_name.'&id='.$cellitems['map_item_id'].'\">Scan </a>\n\t\n\t// salvage?\n\t\t// only happens on items - is similar to scanning...\n\t\t\t// $_GET from <a href=\"actions.php?action=salvage&from='.$file_name.'&id='.$cellitems['map_item_id'].'\">Salvage </a>\n\t\n\t\n\t\n\t//*********************************************//\n\t\n\t// move - set dest coords and arrival timer fields\n\t\t// let the travel script take it from there\n\t\t// $_GET from <a href=\"actions.php?action=move&from='.$file_name.'&loc_x='.$det_loc_x.'&loc_y='.$det_loc_y.'\">Move Here </a>\n\t\t\n\t\t\t\t// use $vehicle_loc_x and y from the vehicleinfo.php include\n\t\tif($_GET[action] == 'move' && isset($_GET[\"loc_x\"]) && isset($_GET[\"loc_y\"]) && isset($_GET[\"from\"])){\n\t\t\t$referer = $_GET[\"from\"];\n\t\t\t// update query for the x,y and calculate the timer for travel...\n\t\t\t\t// change in x squared plus change in y squared = distance squared\n\t\t\t\t$a1 = $vehicle_loc_x;\n\t\t\t\t$a2 = $_GET[\"loc_x\"];\n\t\t\t\tif ($a1 > $a2){$a = $a1 - $a2; }else{$a = $a2 - $a1; }\n\t\t\t\t$b1 = $vehicle_loc_y;\n\t\t\t\t$b2 = $_GET[\"loc_y\"];\n\t\t\t\tif ($b1 > $b2){$b = $b1 - $b2; }else{$b = $b2 - $b1; }\n\t\t\t\t\n\t\t\t\t$c1 = $a*$a + $b*$b;\n\t\t\t\t// default travel speed = 1 minute per unit of travel?\n\t\t\t\t// can get it from the \n\t\t\t\t$s = $vehicle_speed;\n\t\t\t\t$s2 = ($vehicle_speed_modifier / 100);  // as a percentage\n\t\t\t\t$s = $s / $s2;\n\t\t\t\t// $s = 10;\n\t\t\t\t\n\t\t\t\t$c2 = round((sqrt($c1)*$s));\n\t\t\t\t// add the travel value to the current timestamp\n\t\t\t\t$c = time()+$c2;\n\t\t\t\t\n\t\t// also - if is instant travel - take away from energy? and do not add time.\n\t\t// check instant travel field in user db\n\t\t\t\t// instant travel = 0\n\t\t\t\t// timed travel = 1\n\t\t\t\t$instant = $userinfo['user_travel_type'];\n\t\t\t\t// duh... just make the change here, update all the fields if needed, but just make it happen here... lol wow, cant believe i didnt think of it for like 4 weeks...\n\t\t\t\tif($instant == 0){\n\t\t\t\t\t$c = time();\n\t\t\t\t\t$energytotal = ceil($c2/$vehicle_speed);\n\t\t\t\t\t$sqlup = \"UPDATE tbl_vehicles SET vehicle_dest_x = '$a2', vehicle_dest_y = '$b2', vehicle_loc_x = '$a2', vehicle_loc_y = '$b2', vehicle_arrival = '$c' WHERE vehicle_id = '$vehicle_id' and vehicle_user_id = '$user_id' LIMIT 1\";\n\t\t\t\t\t$resultup = mysql_query($sqlup) or die('Query failed. ' . mysql_error()); \n\t\t\t\t\t$query = \"UPDATE tbl_users SET user_energy = user_energy - '$energytotal' WHERE user_id = '$user_id' LIMIT 1\";\n    \t\t\t\t$adjenergy =  mysql_query($query) or die('Query failed. ' . mysql_error());\n\t\t\t\t}else{\n\t\t\t\t\n\t\t$sqlup = \"UPDATE tbl_vehicles SET vehicle_dest_x = '$a2', vehicle_dest_y = '$b2', vehicle_arrival = '$c' WHERE vehicle_id = '$vehicle_id' and vehicle_user_id = '$user_id' LIMIT 1\";\n\n\t\t$resultup = mysql_query($sqlup) or die('Query failed. ' . mysql_error()); \n\t\t\t\t}\n\t\t// after updating the values thus initiating traveling - redirect to the celldetail page for the dest.\n\theader('Location: celldetail.php?loc_x='.$_GET[\"loc_x\"].'&loc_y='.$_GET[\"loc_y\"]);\n\t\t\n\t\t\n\t\t\n\t\t}\n\n\n\n// need to get the previous page path - so can redirect to correct page with whatever messages might be returned...\n\n\n\n// setup redirect via the header Location: xxxxx.php method...\necho 'Nothing should display on this page... so somthing may be wrong here... '.$_POST[\"referer\"].'';\n?>"]],"start1":0,"start2":0,"length1":0,"length2":31091}]],"length":31091}
