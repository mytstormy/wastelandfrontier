{"ts":1374598026124,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"<?php\n/*\n@Author = Kent Savage\n*/\n\n\t// get the vehicle's info\n\t$sqlvehiclelocation = \"SELECT *\n\t        FROM tbl_vehicles, tbl_vehicle_types\n\t\t\tWHERE vehicle_type = vehicle_type_id and vehicle_user_id = '$user_id' and vehicle_active = 1\";\n\t\n\t$resultvehiclelocation = mysql_query($sqlvehiclelocation) or die('Query failed. ' . mysql_error()); \n\t\n\t$vehiclelocation = mysql_fetch_array($resultvehiclelocation,MYSQL_ASSOC);\n\t\n\t\t$vehicle_id = $vehiclelocation['vehicle_id'];\n\t\t$user_id = $vehiclelocation['vehicle_user_id'];\n\t\t$vehicle_type = $vehiclelocation['vehicle_type'];\n\t\t$vehicle_location = $vehiclelocation['vehicle_location'];\n\t\t$vehicle_loc_x = $vehiclelocation['vehicle_loc_x'];\n\t\t$vehicle_loc_y = $vehiclelocation['vehicle_loc_y'];\n\t\t$dest_x = $vehiclelocation['vehicle_dest_x'];\n\t\t$dest_y = $vehiclelocation['vehicle_dest_y'];\n\t\t$vehicle_arrival = $vehiclelocation['vehicle_arrival'];\n\t\t\n\t\t$vehicle_name = $vehiclelocation['vehicle_type_name'];\n\t\t$vehicle_desc = $vehiclelocation['vehicle_type_desc'];\n\t\n\t// check for movement first, then re-run this query...\n// Travel check / update section\n\t\t\n//************************************//\t\n\t\t\n\t\t\t\t\t// a note about vehicle/map logics... the vehicle is the starting point... cant do anything if you dont have one.  \n\t\t\t\t\t\n\t\t\t\t\t// since this vehicle info include will be at the top/in each page, lets check the travel status and update it accordingly here.\n\t\t\t\n\t\t\t//  the vehicle is at its x,y location if not traveling\n\t\t\t\n\t\t\t// use the vehicle status field?  no, it doesnt need to be any more complex that what makes it work.\n\t\t\t\n\t\t\t\t\t// allow users to select instant travel or timer/eco travel?\n\t\t\t\t\t// if using instant travel - energy will be used\n\t\t\t\t\t// if no energy remains - automatically switch to instant?\n\t\t\t\t\t// calculate an arrival timer and apply it\n\t\t\t\t\t// regarding travel - if a destination x,y is set and is different from the vehicle's location, it will enter a travelling state\n\t\t\t\t\t// it will then check for an arrival timer, if none is set, the vehicle will reach the destination instantly\n\t\t\t\t\t// if a timer is set - make sure we are using the same timezone for the timestamp... if its all based on timestamps - we dont have to worry really.\n\t\t\t\t\t// set the timer and wait for the next page refresh  \n\t\t\t\t\t// at next page refresh that runs this include (which has the travel maint scripts) the vehicle will arrive.\n\t\t\t\t\t// that possibly presents a problem, do we allow them to keep their vehicle in limbo as it were?\n\t\t\t\t\t// if the vehicle is in limbo - how can we apply damage or weather or random events in regions?\n\t\t\t\t\t// when other scripts are running on the server \n\t\t\t\t\t// for mob/item/node spawns, do we run a travel script once a minute? that updates all arrivals of vehicular travel?  perhaps...\n\n//*******************************//\n\t\tif (($vehicle_loc_x != $dest_x || $vehicle_loc_y != $dest_y) && $vehicle_arrival < time()){\n\t\t\t\n\t\t$sqlup = \"UPDATE tbl_vehicles SET vehicle_loc_x = '$dest_x', vehicle_loc_y = '$dest_y' WHERE vehicle_id = '$vehicle_id' and vehicle_user_id = '$user_id' LIMIT 1\";\n\n\t\t$resultup = mysql_query($sqlup) or die('Query failed. ' . mysql_error()); \n\t\t\n\t\t}\n\t\n\t$sqlvehiclelocation = \"SELECT *\n\t        FROM tbl_vehicles\n\t\t\tWHERE vehicle_user_id = '$user_id' and vehicle_active = 1\";\n\t\n\t$resultvehiclelocation = mysql_query($sqlvehiclelocation) or die('Query failed. ' . mysql_error()); \n\t\n\t$vehiclelocation = mysql_fetch_array($resultvehiclelocation,MYSQL_ASSOC);\n\t\tif (mysql_num_rows($resultvehiclelocation) == 1) {\n\t\t\t\n\n\t\t$vehicle_id = $vehiclelocation['vehicle_id'];\n\t\t$user_id = $vehiclelocation['vehicle_user_id'];\n\t\t$vehicle_type = $vehiclelocation['vehicle_type'];\n\t\t$vehicle_loc_x = $vehiclelocation['vehicle_loc_x'];\n\t\t$vehicle_loc_y = $vehiclelocation['vehicle_loc_y'];\n\t\t$dest_x = $vehiclelocation['vehicle_dest_x'];\n\t\t$dest_y = $vehiclelocation['vehicle_dest_y'];\n\t\t$vehicle_arrival = $vehiclelocation['vehicle_arrival'];\n\t\t$vehicle_speed = $vehiclelocation['vehicle_speed'];\n\t\t$vehicle_speed_modifier = $vehiclelocation['vehicle_speed_modifier'];\n\t\t$vehicle_current_cargo = $vehiclelocation['vehicle_current_cargo'];\n\t\t$vehicle_max_cargo = $vehiclelocation['vehicle_max_cargo'];\n\t\t\n\t\t$vehicle_core_hp = $vehiclelocation['vehicle_core_hp'];\n\t\t$vehicle_armor_hp = $vehiclelocation['vehicle_armor_hp'];\n\t\t$vehicle_shield_hp = $vehiclelocation['vehicle_shield_hp'];\n\t\t$vehicle_max_shield_hp = $vehiclelocation['vehicle_max_shield_hp'];\n\t\t$vehicle_shield_regen = $vehiclelocation['vehicle_shield_regen'];\n\t\t$vehicle_attack_min = $vehiclelocation['vehicle_attack_min'];\n\t\t$vehicle_attack_max = $vehiclelocation['vehicle_attack_max'];\n\t\t$vehicle_attack_speed = $vehiclelocation['vehicle_attack_speed'];\n\t\t$vehicle_defense = $vehiclelocation['vehicle_defense'];\n\t\t\n\t// get the vehicle type info\nmysql_select_db($database_Rebirth1, $Rebirth1);\n$query_Recordset1 = \"SELECT * FROM tbl_vehicle_types WHERE vehicle_type_id = '$vehicle_type'\";\n$Recordset1 = mysql_query($query_Recordset1, $Rebirth1) or die(mysql_error());\n$row_Recordset1 = mysql_fetch_assoc($Recordset1);\n$totalRows_Recordset1 = mysql_num_rows($Recordset1);\n \n$vehicle_type_name = $row_Recordset1['vehicle_type_name'];\n$vehicle_type_desc = $row_Recordset1['vehicle_type_desc'];\n$vehicle_type_base_hp = $row_Recordset1['vehicle_type_base_hp'];\n$vehicle_type_base_speed = $row_Recordset1['vehicle_type_base_speed'];\n$vehicle_type_base_armor = $row_Recordset1['vehicle_type_base_armor'];\n$vehicle_type_base_attack = $row_Recordset1['vehicle_type_base_attack'];\n$vehicle_type_base_cost = $row_Recordset1['vehicle_type_base_cost'];\n\nmysql_free_result($Recordset1);\n\n\t\t// if 1 vehicle was found - set status to single/active\n\t\t// in the future, possibly more that one ship can be active? perhaps...  we'll leave this possibility open...\n\t\t$vehiclestatus = 'Active';\n\t\t}else{\n\t\t$vehiclestatus = 'Inactive or More than one Vehicle';\n\t\t}\n\t\t\n\t\t\n\t\t\n\t\t\t// now update the total cargo density for speed modifier\n\t\t\t\n\t\t\t\t// query all items in vehicle inventory\n\t\t\t\t$query = \"SELECT * FROM tbl_items, tbl_item_types WHERE item_user_id = '$user_id' and tbl_items.item_type_id = tbl_item_types.item_type_id and item_status = '1' and item_location = '$vehicle_location'\";\n    \t\t\t$stackresultquery =  mysql_query($query) or die('Query failed. ' . mysql_error());\n\t\t\t\t$runtotal = 0;\n\t\t\t\t$volumetotal = 0;\n\t\t\t\t// determine density and total cargo volume\n\t\t\t\twhile($stackresult = mysql_fetch_array($stackresultquery)){\n\t\t\t\t\t$stackid = $stackresult['item_id'];\n\t\t\t\t\t$stackqty = $stackresult['item_qty'];\n\t\t\t\t\t$stackdensity = $stackresult['item_type_density'];\n\t\t\t\t\t$itemstacktotal = $stackqty * $stackdensity;\n\t\t\t\t\t$runtotal = $runtotal + $itemstacktotal;\n\t\t\t\t\t$volumetotal = $volumetotal + $stackqty;\n\t\t\t\t\t}\n\t\t\t\t\t$maxcompval = $vehicle_max_cargo * 75;\n\t\t\t\t\t$densitypercent = ($runtotal/$maxcompval);\n\t\t\t\t\tif($densitypercent > 100){\n\t\t\t\t\t\t$densitypercent = (10000 / $densitypercent);\n\t\t\t\t\t}else{\n\t\t\t\t\t\t$densitypercent = 100;\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t// update vehicle db and speed_modifier value as a % integer - 1-100.\n\t\t\t\t$query = \"UPDATE tbl_vehicles SET vehicle_current_cargo = '$volumetotal', vehicle_speed_modifier = '$densitypercent'  WHERE vehicle_id = '$vehicle_id' LIMIT 1\";\n    \t\t\t\t$adjustcargodensity =  mysql_query($query) or die('Query failed. ' . mysql_error());\n\t\t\t\n\t\t$vehicle_current_cargo = $volumetotal;\n\n\n?>"]],"start1":0,"start2":0,"length1":0,"length2":7372}]],"length":7372}
